var mongoose = require('mongoose');

var env = process.env.NODE_ENV || 'development',
    config = require('./config')[env];

var connect = function () {
    mongoose.connect(config.db, config.mongoose.options);
    require('mongoose-auto-increment').initialize(mongoose.connection);
    console.log(mongoose);
}
connect();


// Error handler
mongoose.connection.on('error', function (err) {
    console.log(err);
});

// 断连时自动重连
mongoose.connection.on('disconnected', function () {
    connect();
});

// mongoose连接
var fs = require('fs');
var models_path = __dirname + '/models';

// 所有的模型
var models = {};

fs.readdirSync(models_path).forEach(function (file) {
    if (~file.indexOf('.js')) {
        console.log("model name : " + file.substring(0, file.lastIndexOf('.js')));
        models[file.substring(0, file.lastIndexOf('.js'))] = require(models_path + '/' + file);
    }
});

exports.models = module.exports.models = models;
exports.AuthManager = require('./singletons/AuthManager');
exports.SystemConfigManager = require('./singletons/SystemConfigManager');
exports.mongoose = module.exports.mongoose = mongoose;